
<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lebo Display</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body {
      background-color: #000;
      font-family: 'Arial', sans-serif;
      margin: 0;
      padding: 10px;
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      box-sizing: border-box;
    }
    .display {
      width: 100%;
      max-width: 420px;
      height: 100%;
      background-color: #221;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      box-sizing: border-box;
    }
    .battery-time {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      font-size: 1.2em;
    }
    .light-button, .bluetooth-button, .setup-button {
      background: none;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      margin: 0 5px;
    }
    .light-button img, .bluetooth-button img, .setup-button img {
      width: 40px;
      height: 40px;
    }
    .light-button:hover, .bluetooth-button:hover, .setup-button:hover {
      opacity: 0.9;
    }
    .circle-wrapper {
      position: relative;
      width: 300px;
      height: 360px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .circle-container {
      position: relative;
      width: 260px;
      height: 260px;
    }
    .power-circle {
      width: 260px;
      height: 260px;
      border-radius: 50%;
      background: conic-gradient(#00ff99 0% 0%, #333 0%);
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1;
      border: 1px solid white;
      box-sizing: border-box;
    }
    .power-inner-circle {
      width: 234px;
      height: 234px;
      border-radius: 50%;
      background: transparent;
      position: absolute;
      top: 13px;
      left: 13px;
      z-index: 2;
      border: 1px solid white;
      box-sizing: border-box;
    }
    .gap-circle {
      width: 234px;
      height: 234px;
      border-radius: 50%;
      background: #000;
      position: absolute;
      top: 13px;
      left: 13px;
      z-index: 3;
      border: 1px solid white;
      box-sizing: border-box;
    }
    .speed-circle {
      width: 221px;
      height: 221px;
      border-radius: 50%;
      background: conic-gradient(#00ff99 0% 0%, #333 0%);
      position: absolute;
      top: 19.5px;
      left: 19.5px;
      z-index: 4;
      border: 1px solid white;
      box-sizing: border-box;
    }
    .inner-circle {
      width: 195px;
      height: 195px;
      background-color: #000;
      border-radius: 50%;
      position: absolute;
      top: 32.5px;
      left: 32.5px;
      z-index: 5;
      border: 1px solid white;
      box-sizing: border-box;
    }
    .value-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 6;
    }
    .speed-value {
      font-size: 3.5em;
      font-weight: bold;
      line-height: 1;
      margin-bottom: 5px;
    }
    .power-value {
      font-size: 1.5em;
      font-weight: bold;
      line-height: 1;
      margin-bottom: 5px;
    }
    .speed-unit, .power-unit {
      font-size: 0.8em;
      line-height: 1;
    }
    .bottom-info {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      margin-top: 10px;
    }
    .trip, .trip-today, .odo, .date {
      text-align: center;
      font-size: 0.95em;
      margin: 5px 0;
      width: 100%;
    }
    .trip {
      cursor: pointer;
    }
    .assist-section {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      margin-top: 10px;
    }
    .assist-minus, .assist-plus {
      flex: 1;
      text-align: center;
    }
    .assist-minus button, .assist-plus button {
      background-color: #00ff99;
      border: none;
      padding: 7.5px 15px;
      margin: 3px;
      font-size: 1.8em;
      border-radius: 5px;
      cursor: pointer;
    }
    .assist-minus button:hover, .assist-plus button:hover {
      opacity: 0.9;
    }
    .assist-circle {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: 3px solid #00ff99;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8em;
      font-weight: bold;
      margin: 0 20px;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      z-index: 10;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background-color: #221;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
      color: white;
    }
    .modal-content h2 {
      margin-top: 0;
      text-align: center;
    }
    .modal-content label {
      display: block;
      margin: 10px 0 5px;
    }
    .modal-content select, .modal-content input {
      width: 100%;
      padding: 8px;
      background-color: #333;
      color: white;
      border: 1px solid #00ff99;
      border-radius: 5px;
    }
    .modal-content button {
      background-color: #00ff99;
      border: none;
      padding: 10px;
      margin: 10px 0;
      width: 100%;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1em;
    }
    .modal-content button:hover {
      opacity: 0.9;
    }
    .close-button {
      background: none;
      border: none;
      color: white;
      font-size: 1.5em;
      position: absolute;
      top: 10px;
      right: 10px;
      cursor: pointer;
    }
    .error-message {
      color: red;
      text-align: center;
      margin: 10px 0;
      display: none;
    }
    .navigation {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      margin: 10px 0;
    }
    .navigation input {
      padding: 8px;
      width: 70%;
      background-color: #333;
      color: white;
      border: 1px solid #00ff99;
      border-radius: 5px;
    }
    .navigation button {
      background-color: #00ff99;
      border: none;
      padding: 8px;
      margin-left: 10px;
      border-radius: 5px;
      cursor: pointer;
    }
    #map {
      height: 300px;
      width: 100%;
      max-width: 420px;
      margin: 10px 0;
    }
    #instructions {
      color: white;
      text-align: center;
      margin: 10px 0;
      font-size: 0.95em;
    }
  </style>
</head>
<body>
  <div class="display">
    <div class="battery-time">
      <div id="batteryDisplay">üîã 0%</div>
      <button id="bluetoothButton" class="bluetooth-button">
        <img src="images/bluetooth_off.png" alt="Bluetooth Off">
      </button>
      <button id="setupButton" class="setup-button">
        <img src="images/setup.png" alt="Setup">
      </button>
      <button id="lightButton" class="light-button">
        <img src="images/grok_image_t6uncz.png" alt="Light Off">
      </button>
      <div id="clockDisplay">00:00</div>
    </div>
    <div class="circle-wrapper">
      <div class="circle-container">
        <div class="power-circle" id="powerCircle"></div>
        <div class="power-inner-circle"></div>
        <div class="gap-circle"></div>
        <div class="speed-circle" id="speedCircle"></div>
        <div class="inner-circle"></div>
        <div class="value-container">
          <div class="speed-value" id="speedDisplay">0.0</div>
          <div class="speed-unit" id="speedUnit">km/h</div>
          <div class="power-value" id="powerDisplay">0</div>
          <div class="power-unit">W</div>
        </div>
      </div>
    </div>
    <div class="bottom-info">
      <div class="trip" id="tripDisplay">TRIP 0.0 km</div>
      <div class="trip-today" id="tripTodayDisplay">TRIP TODAY 0.0 km</div>
      <div class="odo" id="odoDisplay">ODO 1398 km</div>
      <div class="date" id="dateDisplay">13.07.2025</div>
      <div class="assist-section">
        <div class="assist-minus">
          <button id="assistMinusButton">‚àí</button>
        </div>
        <div class="assist-circle" id="assistDisplay">0</div>
        <div class="assist-plus">
          <button id="assistPlusButton">+</button>
        </div>
      </div>
    </div>
    <div class="navigation">
      <input type="text" id="destination" placeholder="Unesi odredi≈°te (npr. Ulica 123, Grad)">
      <button id="startNavigation">Zapoƒçni navigaciju</button>
    </div>
    <div id="map"></div>
    <div id="instructions"></div>
  </div>
  <div id="setupModal" class="modal">
    <div class="modal-content">
      <button class="close-button" id="closeModal">√ó</button>
      <h2>Setup Parameters</h2>
      <div id="errorMessage" class="error-message"></div>
      <h3>General Settings</h3>
      <label for="maxSpeed">Maximum Trip Speed (km/h):</label>
      <input type="number" id="maxSpeed" min="1" max="99" value="25">
      <label for="wheelDiameter">Wheel Diameter (inches):</label>
      <select id="wheelDiameter">
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="8">8</option>
        <option value="10">10</option>
        <option value="12">12</option>
        <option value="14">14</option>
        <option value="16">16</option>
        <option value="18">18</option>
        <option value="20">20</option>
        <option value="22">22</option>
        <option value="24">24</option>
        <option value="26" selected>26</option>
        <option value="700C">700C</option>
        <option value="28">28</option>
        <option value="29">29</option>
      </select>
      <label for="unit">Metric/Imperial Units:</label>
      <select id="unit">
        <option value="0" selected>km/h, km, ¬∞C</option>
        <option value="1">mph, miles, ¬∞C</option>
        <option value="2">km/h, km, ¬∞F</option>
      </select>
      <h3>P Parameters</h3>
      <label for="p1">P1 (Motor Gear Reduction Ratio x Magnet Pieces):</label>
      <input type="number" id="p1" min="1" max="255" value="1">
      <label for="p2">P2 (Wheel Speed Pulse Signal):</label>
      <input type="number" id="p2" min="0" max="6" value="1">
      <label for="p3">P3 (Power Assist Control Mode):</label>
      <select id="p3">
        <option value="0">Speed Control</option>
        <option value="1" selected>Imitation Torque Control</option>
      </select>
      <label for="p4">P4 (Throttle Startup):</label>
      <select id="p4">
        <option value="0">Zero Startup</option>
        <option value="1" selected>Non-Zero Startup</option>
      </select>
      <label for="p5">P5 (Power Monitoring):</label>
      <input type="number" id="p5" min="0" max="40" value="12">
      <h3>C Parameters</h3>
      <label for="c1">C1 (Power-Assist Sensor):</label>
      <select id="c1">
        <option value="0">Forward 5/8/10 Signal (Higher/Standard/Highest)</option>
        <option value="1">Forward 5/8/10 Signal (Lower/Standard)</option>
        <option value="2">Forward 5/8/10 Signal (Lowest/Lower)</option>
        <option value="5">Reverse 6/10/12 Signal (Standard/Higher/Highest)</option>
        <option value="6">Reverse 6/10/12 Signal (Lower/Standard)</option>
        <option value="7">Reverse 6/10/12 Signal (Lowest/Lower)</option>
      </select>
      <label for="c3">C3 (Power Assist Ratio Gear Initialization):</label>
      <select id="c3">
        <option value="0">Gear 0</option>
        <option value="1">Gear 1</option>
        <option value="2">Gear 2</option>
        <option value="3">Gear 3</option>
        <option value="4">Gear 4</option>
        <option value="5">Gear 5</option>
        <option value="8" selected>Restore Last Gear</option>
      </select>
      <label for="c4">C4 (Throttle Function):</label>
      <select id="c4">
        <option value="0">Speed</option>
        <option value="1">Current</option>
        <option value="2">Speed Limit by Gear</option>
        <option value="3">Current Limit by Gear</option>
        <option value="4">Invalid</option>
      </select>
      <label for="c5">C5 (Controller Max Current Adjustment):</label>
      <input type="number" id="c5" min="0" max="10" value="10">
      <label for="c6">C6 (Backlight Brightness):</label>
      <input type="number" id="c6" min="1" max="5" value="3">
      <label for="c7">C7 (Cruise Function):</label>
      <select id="c7">
        <option value="0">Off</option>
        <option value="1" selected>On</option>
      </select>
      <label for="c8">C8 (Motor Temperature Display):</label>
      <select id="c8">
        <option value="0">Off</option>
        <option value="1" selected>On</option>
      </select>
      <label for="c9">C9 (Power-on Password):</label>
      <input type="number" id="c9" min="0" max="999" value="0">
      <label for="c10">C10 (Restore Factory Settings):</label>
      <select id="c10">
        <option value="N" selected>No</option>
        <option value="Y">Yes</option>
      </select>
      <label for="c11">C11 (Meter Attribute):</label>
      <select id="c11">
        <option value="0" selected>LCD8S New Protocol</option>
        <option value="1">LCD1/LCD2 Old Protocol</option>
        <option value="2">Data Source for Copy</option>
      </select>
      <label for="c12">C12 (Controller Min Voltage Adjustment):</label>
      <input type="number" id="c12" min="0" max="7" value="4">
      <label for="c13">C13 (ABS Brakes/Anti-Charge Control):</label>
      <input type="number" id="c13" min="0" max="7" value="0">
      <label for="c14">C14 (Power-Assist Tuning):</label>
      <select id="c14">
        <option value="1">Weak</option>
        <option value="2" selected>General</option>
        <option value="3">Stronger</option>
      </select>
      <h3>L Parameters</h3>
      <label for="l1">L1 (Automatic Under-Voltage):</label>
      <select id="l1">
        <option value="0" selected>Auto</option>
        <option value="1">20V</option>
        <option value="2">30V</option>
        <option value="3">40V</option>
      </select>
      <label for="l2">L2 (Super High-Speed Motor):</label>
      <select id="l2">
        <option value="0" selected>Calculated P1</option>
        <option value="1">P1 > 255</option>
      </select>
      <label for="l4">L4 (Auto Shutdown Delay, minutes):</label>
      <input type="number" id="l4" min="5" max="120" value="5">
      <button id="saveSettings">Save Settings</button>
    </div>
  </div>
  <script>
    // DOM Elements
    const bluetoothButton = document.getElementById('bluetoothButton');
    const assistPlusButton = document.getElementById('assistPlusButton');
    const assistMinusButton = document.getElementById('assistMinusButton');
    const lightButton = document.getElementById('lightButton');
    const setupButton = document.getElementById('setupButton');
    const setupModal = document.getElementById('setupModal');
    const closeModal = document.getElementById('closeModal');
    const saveSettings = document.getElementById('saveSettings');
    const errorMessage = document.getElementById('errorMessage');
    const assistDisplay = document.getElementById("assistDisplay");
    const speedDisplay = document.getElementById("speedDisplay");
    const speedCircle = document.getElementById("speedCircle");
    const speedUnit = document.getElementById("speedUnit");
    const powerDisplay = document.getElementById("powerDisplay");
    const powerCircle = document.getElementById("powerCircle");
    const clockDisplay = document.getElementById("clockDisplay");
    const batteryDisplay = document.getElementById("batteryDisplay");
    const tripDisplay = document.getElementById("tripDisplay");
    const tripTodayDisplay = document.getElementById("tripTodayDisplay");
    const odoDisplay = document.getElementById("odoDisplay");
    const dateDisplay = document.getElementById("dateDisplay");

    // BLE Device Specs
    const deviceName = 'ESP32';
    const bleService = '19b10000-e8f2-537e-4f6c-d104768a1214';
    const sensorCharacteristic = '19b10001-e8f2-537e-4f6c-d104768a1214';
    const ledCharacteristic = '19b10002-e8f2-537e-4f6c-d104768a1214';

    // Global Variables
    let bleServer;
    let bleServiceFound;
    let sensorCharacteristicFound;
    let assistLevel = 0;
    let lightState = false;
    let cachedDevice = null;
    let isConnected = false;
    let currentUnit = 0; // Default to km/h, km, ¬∞C
    let lastDate = null;

    // Load settings, assist level, and trip data from localStorage
    function loadSettings() {
      const savedSettings = localStorage.getItem('ebikeSettings');
      if (savedSettings) {
        const settings = JSON.parse(savedSettings);
        document.getElementById('maxSpeed').value = settings.maxSpeed || 25;
        document.getElementById('wheelDiameter').value = settings.wheelDiameter || '26';
        document.getElementById('unit').value = settings.unit || '0';
        document.getElementById('p1').value = settings.p1 || 1;
        document.getElementById('p2').value = settings.p2 || 1;
        document.getElementById('p3').value = settings.p3 || '1';
        document.getElementById('p4').value = settings.p4 || '1';
        document.getElementById('p5').value = settings.p5 || 12;
        document.getElementById('c1').value = settings.c1 || '0';
        document.getElementById('c3').value = settings.c3 || '8';
        document.getElementById('c4').value = settings.c4 || '0';
        document.getElementById('c5').value = settings.c5 || 10;
        document.getElementById('c6').value = settings.c6 || 3;
        document.getElementById('c7').value = settings.c7 || '1';
        document.getElementById('c8').value = settings.c8 || '1';
        document.getElementById('c9').value = settings.c9 || 0;
        document.getElementById('c10').value = settings.c10 || 'N';
        document.getElementById('c11').value = settings.c11 || '0';
        document.getElementById('c12').value = settings.c12 || 4;
        document.getElementById('c13').value = settings.c13 || 0;
        document.getElementById('c14').value = settings.c14 || '2';
        document.getElementById('l1').value = settings.l1 || '0';
        document.getElementById('l2').value = settings.l2 || '0';
        document.getElementById('l4').value = settings.l4 || 5;
        currentUnit = parseInt(settings.unit) || 0;
        updateUnitDisplay();
        console.log("Settings loaded from localStorage:", settings);
      }

      const savedAssistLevel = localStorage.getItem('assistLevel');
      if (savedAssistLevel !== null) {
        assistLevel = parseInt(savedAssistLevel);
        assistLevel = Math.max(0, Math.min(9, assistLevel)); // Ensure within 0-9
        assistDisplay.textContent = assistLevel;
        console.log("Assist level loaded from localStorage:", assistLevel);
      }

      const savedTrip = localStorage.getItem('tripDistance');
      if (savedTrip !== null) {
        tripDisplay.textContent = `TRIP ${parseFloat(savedTrip).toFixed(1)} ${currentUnit === 1 ? 'miles' : 'km'}`;
        console.log("Trip distance loaded from localStorage:", savedTrip);
      }

      const savedTripToday = localStorage.getItem('tripTodayDistance');
      const savedDate = localStorage.getItem('tripTodayDate');
      const today = new Date().toISOString().split('T')[0];
      if (savedTripToday !== null && savedDate === today) {
        tripTodayDisplay.textContent = `TRIP TODAY ${parseFloat(savedTripToday).toFixed(1)} ${currentUnit === 1 ? 'miles' : 'km'}`;
        console.log("Trip today distance loaded from localStorage:", savedTripToday);
      } else {
        resetTripToday();
      }

      updateDateDisplay();
      lastDate = today;
      resetDisplay();
    }

    // Update unit display based on currentUnit
    function updateUnitDisplay() {
      const unit = currentUnit === 1 ? 'miles' : 'km';
      speedUnit.textContent = currentUnit === 1 ? 'mph' : 'km/h';
      const trip = parseFloat(localStorage.getItem('tripDistance') || '0.0');
      const tripToday = parseFloat(localStorage.getItem('tripTodayDistance') || '0.0');
      const odo = parseFloat(odoDisplay.textContent.split(' ')[1]) || 1398;
      odoDisplay.textContent = `ODO ${Math.round(currentUnit === 1 ? odo * 0.621371 : odo)} ${unit}`;
      tripDisplay.textContent = `TRIP ${(currentUnit === 1 ? trip * 0.621371 : trip).toFixed(1)} ${unit}`;
      tripTodayDisplay.textContent = `TRIP TODAY ${(currentUnit === 1 ? tripToday * 0.621371 : tripToday).toFixed(1)} ${unit}`;
    }

    // Update date display
    function updateDateDisplay() {
      const now = new Date();
      const day = String(now.getDate()).padStart(2, '0');
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const year = now.getFullYear();
      dateDisplay.textContent = `${day}.${month}.${year}`;
    }

    // Check date and reset trip today if necessary
    function checkDateAndResetTripToday() {
      const today = new Date().toISOString().split('T')[0];
      if (today !== lastDate && lastDate !== null) {
        resetTripToday();
      }
      lastDate = today;
      updateDateDisplay();
    }

    // Reset tripTodayDistance
    function resetTripToday() {
      const unit = currentUnit === 1 ? 'miles' : 'km';
      tripTodayDisplay.textContent = `TRIP TODAY 0.0 ${unit}`;
      localStorage.setItem('tripTodayDistance', '0.0');
      localStorage.setItem('tripTodayDate', new Date().toISOString().split('T')[0]);
      console.log("Trip today reset due to new day");
      resetTripTodayOnESP32();
    }

    // Reset tripTodayDistance on ESP32
    function resetTripTodayOnESP32() {
      if (bleServer && bleServer.connected) {
        bleServer.getPrimaryService(bleService)
          .then(service => service.getCharacteristic(ledCharacteristic))
          .then(characteristic => {
            const data = new Uint8Array([252]); // Command to reset trip today
            return characteristic.writeValue(data);
          })
          .then(() => console.log("Trip today reset command sent to ESP32"))
          .catch(error => console.error("Error sending trip today reset to ESP32:", error));
      } else {
        console.log("Not connected to ESP32, trip today reset locally only");
      }
    }

    // Save assist level to localStorage
    function saveAssistLevel() {
      try {
        localStorage.setItem('assistLevel', assistLevel);
        console.log("Assist level saved to localStorage:", assistLevel);
      } catch (error) {
        console.error("Error saving assist level to localStorage:", error);
      }
    }

    // Save trip distances to localStorage
    function saveTripDistances(trip, tripToday) {
      try {
        localStorage.setItem('tripDistance', trip.toFixed(1));
        localStorage.setItem('tripTodayDistance', tripToday.toFixed(1));
        localStorage.setItem('tripTodayDate', new Date().toISOString().split('T')[0]);
        console.log("Trip distances saved to localStorage:", { trip, tripToday });
      } catch (error) {
        console.error("Error saving trip distances to localStorage:", error);
      }
    }

    // Button and Click Event Listeners
    bluetoothButton.addEventListener('click', toggleBluetooth);
    assistPlusButton.addEventListener('click', () => changeAssist(1));
    assistMinusButton.addEventListener('click', () => changeAssist(-1));
    lightButton.addEventListener('click', toggleLight);
    setupButton.addEventListener('click', () => {
      loadSettings();
      setupModal.style.display = 'flex';
    });
    closeModal.addEventListener('click', () => setupModal.style.display = 'none');
    saveSettings.addEventListener('click', saveSettingsToESP32);
    tripDisplay.addEventListener('click', () => {
      if (confirm("Would you like to reset the TRIP to 0.0?")) {
        resetTrip();
      }
    });

    // Clock and Date Update
    function updateClock() {
      const now = new Date();
      const hours = String(now.getHours()).padStart(2, "0");
      const minutes = String(now.getMinutes()).padStart(2, "0");
      clockDisplay.textContent = `${hours}:${minutes}`;
      checkDateAndResetTripToday(); // Check for new day and update date
    }

    // Bluetooth Toggle
    function toggleBluetooth() {
      if (isConnected) {
        disconnectDevice();
      } else {
        connectToDevice();
      }
    }

    // Assist Level Update
    function changeAssist(delta) {
      assistLevel += delta;
      if (assistLevel < 0) assistLevel = 0;
      if (assistLevel > 9) assistLevel = 9;
      assistDisplay.textContent = assistLevel;
      saveAssistLevel();

      if (bleServer && bleServer.connected) {
        bleServer.getPrimaryService(bleService)
          .then(service => service.getCharacteristic(ledCharacteristic))
          .then(characteristic => {
            const data = new Uint8Array([assistLevel]);
            return characteristic.writeValue(data);
          })
          .then(() => console.log("Assist level sent to ESP32:", assistLevel))
          .catch(error => {
            console.error("Error setting assist level:", error);
            updateBluetoothButton();
          });
      } else {
        console.log("Not connected to ESP32");
        updateBluetoothButton();
      }
    }

    // Reset Trip
    function resetTrip() {
      const unit = currentUnit === 1 ? 'miles' : 'km';
      tripDisplay.textContent = `TRIP 0.0 ${unit}`;
      localStorage.setItem('tripDistance', '0.0');
      console.log("Trip distance reset to 0.0");
      if (bleServer && bleServer.connected) {
        bleServer.getPrimaryService(bleService)
          .then(service => service.getCharacteristic(ledCharacteristic))
          .then(characteristic => {
            const data = new Uint8Array([253]); // Command to reset trip
            return characteristic.writeValue(data);
          })
          .then(() => console.log("Trip reset command sent to ESP32"))
          .catch(error => console.error("Error sending trip reset to ESP32:", error));
      }
    }

    // Light Toggle
    function toggleLight() {
      if (!bleServer || !bleServer.connected) {
        console.log("Not connected to ESP32");
        updateBluetoothButton();
        return;
      }

      lightState = !lightState;
      bleServer.getPrimaryService(bleService)
        .then(service => service.getCharacteristic(ledCharacteristic))
        .then(characteristic => {
          const data = new Uint8Array([lightState ? 255 : 254]);
          return characteristic.writeValue(data);
        })
        .then(() => {
          console.log("Light set to:", lightState ? "ON" : "OFF");
          lightButton.innerHTML = `<img src="images/${lightState ? 'on.png' : 'grok_image_t6uncz.png'}" alt="Light ${lightState ? 'On' : 'Off'}">`;
          updateBluetoothButton();
        })
        .catch(error => {
          console.error("Error toggling light:", error);
          lightState = !lightState;
          lightButton.innerHTML = `<img src="images/${lightState ? 'on.png' : 'grok_image_t6uncz.png'}" alt="Light ${lightState ? 'On' : 'Off'}">`;
          updateBluetoothButton();
        });
    }

    // Save Settings to localStorage and ESP32
    function saveSettingsToESP32() {
      const errorMessageElement = document.getElementById('errorMessage');
      errorMessageElement.style.display = 'none';
      errorMessageElement.textContent = '';

      const settings = {
        maxSpeed: parseInt(document.getElementById('maxSpeed').value) || 25,
        wheelDiameter: document.getElementById('wheelDiameter').value || '26',
        unit: parseInt(document.getElementById('unit').value) || 0,
        p1: parseInt(document.getElementById('p1').value) || 1,
        p2: parseInt(document.getElementById('p2').value) || 1,
        p3: parseInt(document.getElementById('p3').value) || 1,
        p4: parseInt(document.getElementById('p4').value) || 1,
        p5: parseInt(document.getElementById('p5').value) || 12,
        c1: parseInt(document.getElementById('c1').value) || 0,
        c3: parseInt(document.getElementById('c3').value) || 8,
        c4: parseInt(document.getElementById('c4').value) || 0,
        c5: parseInt(document.getElementById('c5').value) || 10,
        c6: parseInt(document.getElementById('c6').value) || 3,
        c7: parseInt(document.getElementById('c7').value) || 1,
        c8: parseInt(document.getElementById('c8').value) || 1,
        c9: parseInt(document.getElementById('c9').value) || 0,
        c10: document.getElementById('c10').value || 'N',
        c11: parseInt(document.getElementById('c11').value) || 0,
        c12: parseInt(document.getElementById('c12').value) || 4,
        c13: parseInt(document.getElementById('c13').value) || 0,
        c14: parseInt(document.getElementById('c14').value) || 2,
        l1: parseInt(document.getElementById('l1').value) || 0,
        l2: parseInt(document.getElementById('l2').value) || 0,
        l4: parseInt(document.getElementById('l4').value) || 5
      };

      try {
        localStorage.setItem('ebikeSettings', JSON.stringify(settings));
        currentUnit = settings.unit;
        updateUnitDisplay();
        console.log("Settings saved to localStorage:", settings);
      } catch (error) {
        console.error("Error saving to localStorage:", error);
        errorMessageElement.textContent = "Failed to save settings locally.";
        errorMessageElement.style.display = 'block';
        setupModal.style.display = 'none';
        return;
      }

      if (!bleServer || !bleServer.connected) {
        console.log("Not connected to ESP32, saving locally only");
        errorMessageElement.textContent = "Not connected to ESP32. Settings saved locally.";
        errorMessageElement.style.display = 'block';
        setupModal.style.display = 'none';
        updateBluetoothButton();
        return;
      }

      const dataString = JSON.stringify(settings);
      if (dataString.length > 512) {
        console.error("Settings data too large for BLE:", dataString.length);
        errorMessageElement.textContent = "Settings data too large for Bluetooth.";
        errorMessageElement.style.display = 'block';
        setupModal.style.display = 'none';
        return;
      }

      const data = new TextEncoder().encode(dataString);

      bleServer.getPrimaryService(bleService)
        .then(service => service.getCharacteristic(ledCharacteristic))
        .then(characteristic => characteristic.writeValue(data))
        .then(() => {
          console.log("Settings sent to ESP32:", settings);
          setupModal.style.display = 'none';
        })
        .catch(error => {
          console.error("Error sending settings to ESP32:", error);
          errorMessageElement.textContent = "Failed to send settings to ESP32.";
          errorMessageElement.style.display = 'block';
          setupModal.style.display = 'none';
          updateBluetoothButton();
        });
    }

    // Speed Update
    function updateSpeed(speed) {
      const displaySpeed = currentUnit === 1 ? speed * 0.621371 : speed;
      speedDisplay.textContent = displaySpeed.toFixed(1);
      const maxSpeed = parseInt(document.getElementById('maxSpeed').value) || 25;
      const displayMaxSpeed = currentUnit === 1 ? maxSpeed * 0.621371 : maxSpeed;
      const speedPercent = Math.min((displaySpeed / displayMaxSpeed) * 100, 100);
      speedCircle.style.background = `conic-gradient(#00ff99 0% ${speedPercent}%, #333 ${speedPercent}% 100%)`;
    }

    // Power Update
    function updatePower(power) {
      powerDisplay.textContent = Math.round(power);
      const powerPercent = Math.min((power / 1000) * 100, 100);
      let color = '#00ff99';
      if (power > 700) color = 'red';
      else if (power > 300) color = 'orange';
      powerCircle.style.background = `conic-gradient(${color} 0% ${powerPercent}%, #333 ${powerPercent}% 100%)`;
      powerDisplay.style.color = color;
    }

    // Battery and Trip Update
    function updateDisplay(battery, trip, tripToday, odo) {
      batteryDisplay.textContent = `üîã ${Math.round(battery)}%`;
      const unit = currentUnit === 1 ? 'miles' : 'km';
      const displayTrip = currentUnit === 1 ? trip * 0.621371 : trip;
      const displayTripToday = currentUnit === 1 ? tripToday * 0.621371 : tripToday;
      const displayOdo = currentUnit === 1 ? odo * 0.621371 : odo;
      tripDisplay.textContent = `TRIP ${displayTrip.toFixed(1)} ${unit}`;
      tripTodayDisplay.textContent = `TRIP TODAY ${displayTripToday.toFixed(1)} ${unit}`;
      odoDisplay.textContent = `ODO ${Math.round(displayOdo)} ${unit}`;
      saveTripDistances(trip, tripToday);
    }

    // BLE Functions
    function isWebBluetoothEnabled() {
      if (!navigator.bluetooth) {
        console.log("Web Bluetooth is not supported in this browser. Use Chrome, Edge, or Opera with HTTPS or file://");
        updateBluetoothButton();
        return false;
      }
      return true;
    }

    async function connectToDevice() {
      if (!isWebBluetoothEnabled()) return;

      resetDisplay();

      try {
        let device;
        if (cachedDevice && cachedDevice.gatt) {
          console.log("Attempting to reconnect to cached device:", cachedDevice.name);
          updateBluetoothButton();
          device = cachedDevice;
        } else {
          console.log("Requesting Bluetooth device...");
          device = await navigator.bluetooth.requestDevice({
            filters: [{ name: deviceName }],
            optionalServices: [bleService]
          });
          cachedDevice = device;
          updateBluetoothButton();
        }

        device.addEventListener('gattserverdisconnected', () => {
          resetDisplay();
          bleServer = null;
          isConnected = false;
          updateBluetoothButton();
        });

        bleServer = await device.gatt.connect();
        isConnected = true;
        bleServiceFound = await bleServer.getPrimaryService(bleService);
        sensorCharacteristicFound = await bleServiceFound.getCharacteristic(sensorCharacteristic);
        sensorCharacteristicFound.addEventListener('characteristicvaluechanged', handleDataChange);
        await sensorCharacteristicFound.startNotifications();
        updateBluetoothButton();

        bleServer.getPrimaryService(bleService)
          .then(service => service.getCharacteristic(ledCharacteristic))
          .then(characteristic => characteristic.readValue())
          .then(value => {
            const assist = new DataView(value.buffer).getUint8(0);
            if (assist >= 0 && assist <= 9) {
              assistLevel = assist;
              assistDisplay.textContent = assistLevel;
              saveAssistLevel();
              console.log("Assist level loaded from ESP32:", assistLevel);
            }
          })
          .catch(error => console.error("Error reading assist level from ESP32:", error));
      } catch (error) {
        console.error('Error connecting to ESP32:', error);
        isConnected = false;
        updateBluetoothButton();
        resetDisplay();
      }
    }

    function updateBluetoothButton() {
      bluetoothButton.innerHTML = `<img src="images/${isConnected ? 'bluetooth_on.png' : 'bluetooth_off.png'}" alt="Bluetooth ${isConnected ? 'On' : 'Off'}">`;
    }

    function handleDataChange(event) {
      const data = new TextDecoder().decode(event.target.value);
      handleDataUpdate(data);
    }

    function handleDataUpdate(data) {
      const [speed, power, trip, tripToday, odo, battery] = data.split(':').map(val => parseFloat(val));
      if (isNaN(speed) || isNaN(power) || isNaN(trip) || isNaN(tripToday) || isNaN(odo) || isNaN(battery)) {
        console.error("Invalid data received:", data);
        return;
      }
      updateSpeed(speed);
      updatePower(power);
      updateDisplay(battery, trip, tripToday, odo);
      console.log(`Updated - Speed: ${speed} km/h, Power: ${power} W, Trip: ${trip} km, Trip Today: ${tripToday} km, Odo: ${odo} km, Battery: ${battery}%`);
      isConnected = true;
      updateBluetoothButton();
    }

    function resetDisplay() {
      updateSpeed(0);
      updatePower(0);
      batteryDisplay.textContent = `üîã 0%`;
      const unit = currentUnit === 1 ? 'miles' : 'km';
      const trip = parseFloat(localStorage.getItem('tripDistance') || '0.0');
      const tripToday = parseFloat(localStorage.getItem('tripTodayDistance') || '0.0');
      const odo = 1398;
      tripDisplay.textContent = `TRIP ${(currentUnit === 1 ? trip * 0.621371 : trip).toFixed(1)} ${unit}`;
      tripTodayDisplay.textContent = `TRIP TODAY ${(currentUnit === 1 ? tripToday * 0.621371 : tripToday).toFixed(1)} ${unit}`;
      odoDisplay.textContent = `ODO ${Math.round(currentUnit === 1 ? odo * 0.621371 : odo)} ${unit}`;
      updateDateDisplay();
      lightState = false;
      lightButton.innerHTML = `<img src="images/grok_image_t6uncz.png" alt="Light Off">`;
      isConnected = false;
      updateBluetoothButton();
    }

    function disconnectDevice() {
      if (bleServer && bleServer.connected) {
        if (sensorCharacteristicFound) {
          sensorCharacteristicFound.stopNotifications()
            .then(() => bleServer.disconnect())
            .then(() => {
              console.log("Device Disconnected");
              bleServer = null;
              sensorCharacteristicFound = null;
              resetDisplay();
              isConnected = false;
              updateBluetoothButton();
            })
            .catch(error => {
              console.error("Error disconnecting:", error);
              isConnected = false;
              updateBluetoothButton();
              resetDisplay();
            });
        } else {
          bleServer.disconnect()
            .then(() => {
              console.log("Device Disconnected");
              bleServer = null;
              resetDisplay();
              isConnected = false;
              updateBluetoothButton();
            })
            .catch(error => {
              console.error("Error disconnecting:", error);
              isConnected = false;
              updateBluetoothButton();
              resetDisplay();
            });
        }
      } else {
        console.log("Not connected to ESP32");
        isConnected = false;
        updateBluetoothButton();
        resetDisplay();
      }
    }

    // Navigation Functions
    let map, routeLayer, currentPositionMarker, watchId;

    function initMap() {
      map = L.map('map').setView([45.8150, 15.9819], 13); // Zadana lokacija (npr. Zagreb)
      L.tileLayer('https://{s}.tile-cyclosm.openstreetmap.fr/cyclosm/{z}/{x}/{y}.png', {
        attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);
    }

    function updateCurrentPosition(lat, lon) {
      if (currentPositionMarker) map.removeLayer(currentPositionMarker);
      currentPositionMarker = L.marker([lat, lon]).addTo(map);
      map.setView([lat, lon], 15);
    }

    function displayRoute(coordinates) {
      if (routeLayer) map.removeLayer(routeLayer);
      routeLayer = L.polyline(coordinates.map(c => [c[1], c[0]]), { color: '#00ff99' }).addTo(map);
      map.fitBounds(routeLayer.getBounds());
    }

    function displayInstructions(instructions, distances, bearings) {
      const instructionsDiv = document.getElementById('instructions');
      const formattedInstructions = instructions.map((instr, i) => {
        const distance = Math.round(distances[i]);
        const arrow = getArrowFromBearing(bearings[i]);
        return `${arrow} ${instr} (${distance} m)`;
      });
      instructionsDiv.innerHTML = formattedInstructions.join('<br>');
      if (formattedInstructions.length > 0) speakInstruction(formattedInstructions[0]);
    }

    function getArrowFromBearing(bearing) {
      if (bearing == null) return '‚¨Ü';
      bearing = (bearing + 360) % 360;
      if (bearing >= 315 || bearing < 45) return '‚¨Ü'; // Sjever
      if (bearing >= 45 && bearing < 135) return '‚û°'; // Istok
      if (bearing >= 135 && bearing < 225) return '‚¨á'; // Jug
      if (bearing >= 225 && bearing < 315) return '‚¨Ö'; // Zapad
      return '‚¨Ü';
    }

    function speakInstruction(text) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'hr-HR';
      window.speechSynthesis.speak(utterance);
    }

    async function geocodeAddress(address) {
      try {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(address)}&format=json&limit=1`, {
          headers: { 'User-Agent': 'eBikeNav/1.0' }
        });
        const data = await response.json();
        return data.length > 0 ? { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) } : null;
      } catch (error) {
        console.error("Geocoding error:", error);
        return null;
      }
    }

    async function getRoute(start, end) {
      try {
        const url = `http://router.project-osrm.org/route/v1/bicycle/${start.lon},${start.lat};${end.lon},${end.lat}?overview=full&geometries=geojson&steps=true`;
        const response = await fetch(url);
        const data = await response.json();
        if (data.routes && data.routes.length > 0) {
          const coordinates = data.routes[0].geometry.coordinates;
          const steps = data.routes[0].legs[0].steps;
          const instructions = steps.map(step => step.maneuver.instruction);
          const distances = steps.map(step => step.distance);
          const bearings = steps.map(step => step.maneuver.bearing_after);
          return { coordinates, instructions, distances, bearings };
        }
        return null;
      } catch (error) {
        console.error("Routing error:", error);
        return null;
      }
    }

    function getCurrentPosition(callback) {
      navigator.geolocation.getCurrentPosition(
        (position) => callback({ lat: position.coords.latitude, lon: position.coords.longitude }),
        (error) => {
          console.error("GPS error:", error);
          alert("Nije moguƒáe dobiti GPS poziciju. Provjeri dozvole.");
        },
        { enableHighAccuracy: true }
      );
    }

    function watchPosition(callback) {
      watchId = navigator.geolocation.watchPosition(
        (position) => callback({ lat: position.coords.latitude, lon: position.coords.longitude }),
        (error) => console.error("GPS watch error:", error),
        { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
      );
    }

    function stopWatching() {
      if (watchId) navigator.geolocation.clearWatch(watchId);
    }

    // Initialize map and add navigation event listener
    window.onload = function() {
      loadSettings();
      initMap();
      document.getElementById('startNavigation').addEventListener('click', async () => {
        const address = document.getElementById('destination').value;
        if (!address) {
          alert('Unesi odredi≈°te!');
          return;
        }
        getCurrentPosition(async (start) => {
          const end = await geocodeAddress(address);
          if (!end) {
            alert('Ne mogu pronaƒái odredi≈°te!');
            return;
          }
          const route = await getRoute(start, end);
          if (route) {
            displayRoute(route.coordinates);
            displayInstructions(route.instructions, route.distances, route.bearings);
            watchPosition((pos) => {
              updateCurrentPosition(pos.lat, pos.lon);
              // A≈æuriraj upute u stvarnom vremenu
              getRoute(pos, end).then(newRoute => {
                if (newRoute) {
                  displayRoute(newRoute.coordinates);
                  displayInstructions(newRoute.instructions, newRoute.distances, newRoute.bearings);
                }
              });
            });
          } else {
            alert('Ne mogu izraƒçunati rutu!');
          }
        });
      });
    };

    updateClock();
    setInterval(updateClock, 1000);
  </script>
</body>
</html>
