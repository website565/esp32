<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OsmAnd Map - Live Location</title>
    <!-- Leaflet CSS and JS for 2D map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Mapbox GL JS for 3D attempt -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; }
        #map2D { height: 100vh; width: 100vw; } /* 2D map, full screen */
        #map3D { height: 100vh; width: 100vw; display: none; } /* 3D map, full screen */
        #toggleView { 
            position: fixed; 
            top: 10px; 
            left: 50%; 
            transform: translateX(-50%); 
            z-index: 1000; 
            padding: 10px 20px; 
            background: #0078A8; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            font-size: 16px; 
            cursor: pointer; 
        }
        #errorMessage { 
            position: fixed; 
            top: 50px; 
            left: 50%; 
            transform: translateX(-50%); 
            z-index: 1000; 
            background: #ff4444; 
            color: white; 
            padding: 10px; 
            border-radius: 5px; 
            display: none; 
        }
    </style>
</head>
<body>
    <button id="toggleView" onclick="toggleView()">Switch to 3D</button>
    <div id="errorMessage"></div>
    <div id="map2D"></div>
    <div id="map3D"></div>

    <script>
        let is3DView = false; // Start with 2D view (more reliable)
        let map2D, map3D, marker2D, marker3D;
        let currentZoom = 15; // Store current zoom level
        let lastLat, lastLng; // Store last known position

        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.innerText = message;
            errorDiv.style.display = 'block';
            setTimeout(() => { errorDiv.style.display = 'none'; }, 5000);
        }

        // Function to toggle between 2D and 3D views
        function toggleView() {
            is3DView = !is3DView;
            document.getElementById('map2D').style.display = is3DView ? 'none' : 'block';
            document.getElementById('map3D').style.display = is3DView ? 'block' : 'none';
            document.getElementById('toggleView').innerText = is3DView ? 'Switch to 2D' : 'Switch to 3D';
            if (!is3DView && map2D) map2D.invalidateSize();
            if (is3DView && map3D) map3D.resize();
        }

        // Initialize 2D Leaflet map
        function initLeafletMap(lat, lng) {
            map2D = L.map('map2D', {
                zoomControl: false // Remove zoom control for cleaner look
            }).setView([lat, lng], currentZoom);
            // OSM layer (similar to OsmAnd)
            const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            });
            // Satellite layer (Esri World Imagery)
            const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                maxZoom: 19,
                attribution: '© Esri'
            });
            // Add layers
            osmLayer.addTo(map2D);
            // Layer control
            const baseLayers = {
                "OpenStreetMap": osmLayer,
                "Satellite View": satelliteLayer
            };
            L.control.layers(baseLayers, null, { position: 'topright' }).addTo(map2D);
            // Marker for current location
            marker2D = L.marker([lat, lng]).addTo(map2D).bindPopup("Your current location").openPopup();
            // Update zoom level when user zooms
            map2D.on('zoomend', () => {
                currentZoom = map2D.getZoom();
            });
        }

        // Initialize 3D Mapbox map (OSM fallback, no token required)
        function initMapboxMap(lat, lng) {
            try {
                // Use OSM tiles (no token needed)
                map3D = new mapboxgl.Map({
                    container: 'map3D',
                    style: {
                        version: 8,
                        sources: {
                            osm: {
                                type: 'raster',
                                tiles: ['https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'],
                                tileSize: 256,
                                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                            }
                        },
                        layers: [{
                            id: 'osm',
                            type: 'raster',
                            source: 'osm'
                        }]
                    },
                    center: [lng, lat],
                    zoom: currentZoom,
                    pitch: 60, // Tilt for 3D effect
                    bearing: 0,
                    antialias: true
                });
                // Add navigation control (zoom only)
                map3D.addControl(new mapboxgl.NavigationControl({ showCompass: false }), 'top-right');
                // Add marker
                marker3D = new mapboxgl.Marker({ color: 'red' })
                    .setLngLat([lng, lat])
                    .setPopup(new mapboxgl.Popup().setText('Your current location'))
                    .addTo(map3D);
                // Update zoom level when user zooms
                map3D.on('zoomend', () => {
                    currentZoom = map3D.getZoom();
                });
                // Handle Mapbox load errors
                map3D.on('error', (e) => {
                    console.error("Mapbox error:", e);
                    showError("Failed to load 3D map. Try switching to 2D.");
                });
            } catch (error) {
                console.error("Error initializing Mapbox:", error);
                showError("Failed to load 3D map. Check your internet or browser compatibility.");
            }
        }

        // Update location for 2D and 3D maps
        function updateLocation(lat, lng) {
            // Only update view if location changed significantly to avoid zoom reset
            const distanceThreshold = 0.001; // ~100 meters
            if (!lastLat || !lastLng || 
                Math.abs(lat - lastLat) > distanceThreshold || 
                Math.abs(lng - lastLng) > distanceThreshold) {
                if (map2D && marker2D) {
                    map2D.setView([lat, lng], currentZoom);
                    marker2D.setLatLng([lat, lng]);
                    marker2D.bindPopup("Your current location").openPopup();
                }
                if (map3D && marker3D) {
                    map3D.setCenter([lng, lat]);
                    map3D.setZoom(currentZoom);
                    marker3D.setLngLat([lng, lat]);
                }
                lastLat = lat;
                lastLng = lng;
            }
        }

        // Watch for location updates
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    lastLat = lat;
                    lastLng = lng;
                    initLeafletMap(lat, lng);
                    initMapboxMap(lat, lng);
                    // Start watching for location updates
                    navigator.geolocation.watchPosition(
                        (pos) => {
                            updateLocation(pos.coords.latitude, pos.coords.longitude);
                        },
                        (error) => {
                            console.error("Error watching location:", error);
                            showError("Unable to update location.");
                        },
                        { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                    );
                },
                (error) => {
                    console.error("Error getting initial location:", error);
                    showError("Unable to get location. Using default location (Zagreb).");
                    // Fallback to Zagreb
                    initLeafletMap(45.8150, 15.9819);
                    initMapboxMap(45.8150, 15.9819);
                }
            );
        } else {
            showError("Geolocation is not supported by your browser.");
            // Fallback to Zagreb
            initLeafletMap(45.8150, 15.9819);
            initMapboxMap(45.8150, 15.9819);
        }
    </script>
</body>
</html>